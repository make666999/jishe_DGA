<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图表分析</title>
    <script src="./static/global.js"></script>
    <link rel="stylesheet" type="text/css" href="./static/ditu/css/visual.css">
    <script src="./static/ditu/js/echarts.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/remixicon@2.2.0/fonts/remixicon.css'>
    <link rel='stylesheet' href='https://unpkg.com/css-pro-layout@1.1.0/dist/css/css-pro-layout.css'>
    <link rel='stylesheet' href='https://fonts.googleapis.com/css2?family=Poppins:wght@100;200;300;400;500;600;700;800;900&amp;display=swap'>
    <link rel="stylesheet" href="./static/css/style.css">
    <link rel="stylesheet" href="./static/css/charts.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.css">
</head>

<body>

<!-- partial:index.partial -->
<div class="layout has-sidebar fixed-sidebar fixed-header">
    <aside id="sidebar" class="sidebar break-point-sm has-bg-image">
    <div class="sidebar-layout">
      <div class="sidebar-header">
        <div class="pro-sidebar-logo">
          <a href="./index.html">
            <h5>DGA域名检测系统</h5>
          </a>
        </div>
      </div>
      <div class="sidebar-content">
        <nav class="menu open-current-submenu">
          <ul>
            <li class="menu-item sub-menu">
              <a href="./home.html">
                <span class="menu-icon">
                  <i class="ri-vip-diamond-fill"></i>
                </span>
                <span class="menu-title">系统首页</span>
              </a>
            </li>
          </ul>
          <ul>
            <li class="menu-item sub-menu">
              <a href="./database.html">
                <span class="menu-icon">
                  <i class="ri-bar-chart-2-fill"></i>
                </span>
                <span class="menu-title">动态抓取</span>
              </a>
            </li>
            <li class="menu-item sub-menu">
              <a href="./type.html">
                <span class="menu-icon">
                  <i class="ri-global-fill"></i>
                </span>
                <span class="menu-title">状态查询</span>
              </a>
            </li>
            <li class="menu-item sub-menu">
              <a href="./Charts.html">
                <span class="menu-icon">
                 <i class="ri-paint-brush-fill"></i>
                </span>
                <span class="menu-title">图表分析</span>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </aside>

    <div style="height: 5%; width: 5%; padding-top: 5%">
        <h5>请下拉选择框，选择查看的用户数据</h5>
        <h1><span id="User">暂无</span>用户的数据分析</h1>
        <select style="float: left; color: #12fe81" id="collectionSelect">
            <!-- 默认选项 -->
            <option value="" disabled selected id="sendButton">Select a collection</option>
        </select>
    </div>
    <div class="left">
        <div class="visual_box">
            <div class="visual_title">
                <span>网络攻击分析趋势图</span>
            </div>
            <div class="visual_chart" id="main2">
                <!-- 在这里插入折线图的内容 -->
            </div>
        </div>
        <div class="chart-container" id="bar-chart">
            <label class="label label-success">Bar Chart</label>
        </div>
    </div>
    <div class="right">
        <div class="chart-container" id="stacked">
            <label class="label label-success">Bar stacked</label>
        </div>
        <div class="chart-container" id="pie-chart">
            <label class="label label-success">Pie Chart</label>
        </div>
    </div>

</div>


<!-- Scripts -->


<script>

    const selectElement = document.getElementById("collectionSelect");
    // 创建WebSocket连接

    const socket = new WebSocket('ws://192.168.78.71:8000/collection_names');

    socket.addEventListener("message", function (event) {
        const collectionNames = JSON.parse(event.data);
        updateDropdown(collectionNames);
    });

    function updateDropdown(collectionNames) {
        // 清空下拉框
        selectElement.innerHTML = "";

        // 添加默认选项
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.disabled = true;
        defaultOption.selected = true;
        defaultOption.textContent = "Select a collection";
        selectElement.appendChild(defaultOption);

        // 添加集合名称选项
        collectionNames.forEach(function (collectionName) {
            const option = document.createElement("option");
            option.value = collectionName;
            console.log(collectionName);
            option.textContent = collectionName;
            selectElement.appendChild(option);
        });
    }

    let currentTime = null;
    const socket_Time = new WebSocket(`ws://${ipAddress}/count_per_six_seconds`);
    socket_Time.onmessage = (event) => {
        try {
            const time_data = JSON.parse(event.data);
            console.log(time_data);
            var myChart2 = echarts.init(document.getElementById('main2'));
            option2 = {
                tooltip: {//鼠标指上时的标线
                    trigger: 'axis',
                    axisPointer: {
                        lineStyle: {
                            color: '#f5f3f3'
                        }
                    }
                },
                legend: {
                    icon: 'rect',
                    itemWidth: 14,
                    itemHeight: 5,
                    itemGap: 13,
                    data: ['ddos'],
                    right: '10px',
                    top: '0px',
                    textStyle: {
                        fontSize: 12,
                        color: '#fff'
                    }
                },
                grid: {
                    x: 35,
                    y: 25,
                    x2: 8,
                    y2: 25,
                },
                xAxis: [{
                    type: 'category',
                    boundaryGap: false,
                    axisLine: {
                        lineStyle: {
                            color: '#57617B'
                        }
                    },
                    axisLabel: {
                        textStyle: {
                            color: '#fff',
                        },
                    },
                    data: time_data.data
                }],
                yAxis: [{
                    type: 'value',
                    axisTick: {
                        show: false
                    },
                    axisLine: {
                        lineStyle: {
                            color: '#57617B'
                        }
                    },
                    axisLabel: {
                        margin: 10,
                        textStyle: {
                            fontSize: 14
                        },
                        textStyle: {
                            color: '#fff',
                        },
                    },
                    splitLine: {
                        lineStyle: {
                            color: '#57617B'
                        }
                    }
                }],
                series: [{
                    name: 'ddos',
                    type: 'line',
                    smooth: true,
                    lineStyle: {
                        normal: {
                            width: 2
                        }
                    },
                    areaStyle: {
                        normal: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                                offset: 0,
                                color: 'rgba(137, 189, 27, 0.3)'
                            }, {
                                offset: 0.8,
                                color: 'rgba(137, 189, 27, 0)'
                            }], false),
                            shadowColor: 'rgba(0, 0, 0, 0.1)',
                            shadowBlur: 10
                        }
                    },
                    itemStyle: {
                        normal: {
                            color: 'rgb(137,189,27)'
                        }
                    },
                    data: time_data.count
                }
                ]
            };
            myChart2.setOption(option2);
        } catch (error) {
            console.error("JSON 解析错误：", error);
        }
    }

    document.getElementById("sendButton").addEventListener("click", sendData);

    function sendData() {
        const selectedCollection = selectElement.value;  // Get the selected value from dropdown
        const dataToSend = {Local: selectedCollection, Time: "value2"};
        User.innerHTML = dataToSend.Local;
        fetch('/api/send_data', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dataToSend)
        })
            .then(response => response.json())
            .then(data => {
                console.log('Response from FastAPI:', data);
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    selectElement.addEventListener("change", sendData);

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/morris.js/0.5.1/morris.min.js"></script>
<script src="./static/js/Charts.js"></script>
</body>
</html>
